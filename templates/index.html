<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Candidate Screener - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        .selected-project { background-color: var(--color-border); }
        html, body { height: 100%; margin: 0; background-color: var(--color-primary-bg); }
        body { display: flex; }
        #sidebar { width: 25%; min-width: 280px; max-width: 400px; height: 100vh; overflow-y: auto; flex-shrink: 0; background-color: #2B2E4A; border-right: 1px solid var(--color-border); }
        #main-content { flex-grow: 1; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .project-item { cursor: pointer; transition: background 0.2s; }
        .candidate-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .candidate-score { min-width: 50px; text-align: right; }
    </style>
</head>
<body class="text-gray-200 flex">

    <div id="sidebar" class="p-4 flex flex-col">
        <h1 class="text-2xl font-bold text-white mb-6">Projects</h1>
        <button id="new-project-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg mb-4 flex items-center justify-center gap-2 text-sm">
            <ion-icon name="add-circle-outline"></ion-icon> New Project
        </button>
        <input type="text" id="project-search" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Filter projects...">
        <div id="project-list" class="flex-grow space-y-1 overflow-y-auto">
            <p class="text-gray-400 text-sm p-2">Loading projects...</p>
        </div>
    </div>

    <div id="main-content">
        
        <div class="bg-gray-800 border-b border-gray-700 px-8 py-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex-1 max-w-2xl">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <ion-icon name="search-outline" class="text-gray-400"></ion-icon>
                    </div>
                    <input type="text" id="global-candidate-search" class="block w-full pl-10 pr-3 py-2 border border-gray-600 rounded-lg leading-5 bg-gray-900 text-gray-300 placeholder-gray-500 focus:outline-none focus:bg-gray-800 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 sm:text-sm" placeholder="Search candidate in this project...">
                </div>
            </div>
            <div class="ml-4 flex items-center text-sm text-gray-400">
                <ion-icon name="person-circle-outline" class="text-2xl mr-2"></ion-icon>
                <span>Admin</span>
            </div>
        </div>

        <div class="flex-grow p-8 overflow-y-auto">

            <div id="welcome-message" class="text-center p-10">
                <h2 class="text-3xl font-bold text-white mb-4">Welcome</h2>
                <p class="text-lg text-gray-400">Select a project from the sidebar to manage candidates.</p>
            </div>

            <div id="create-project-form" class="hidden glass-card p-6 rounded-2xl shadow-xl max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-6">Create New Project</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Project Name</label><input type="text" id="project-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3"></div>
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Job Description</label><textarea id="project-jd" rows="12" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3"></textarea></div>
                    <div class="flex justify-end gap-3"><button id="cancel-project-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="save-project-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Save Project</button></div>
                </div>
            </div>

            <div id="project-dashboard" class="hidden">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 id="project-title-display" class="text-3xl font-bold text-white">Project Name</h2>
                        <p class="text-gray-400 text-sm mt-1">Manage and analyze candidates for this role.</p>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-2xl shadow-xl mb-8 max-w-4xl mx-auto">
                    <h3 class="text-lg font-semibold text-white mb-4 border-b border-gray-700 pb-2">Analyze New Candidate</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-300 mb-1">GitHub Username</label><input type="text" id="username-input" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2" placeholder="github_username"></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-1">LinkedIn (Optional)</label><input type="file" id="linkedin-file" accept="application/pdf" class="w-full text-gray-300 file:mr-2 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:bg-gray-700 file:text-sky-300 hover:file:bg-gray-600 border border-gray-600 rounded-lg cursor-pointer"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-300 mb-1">Resume (PDF) <span class="text-red-400">*</span></label><input type="file" id="resume-file" accept="application/pdf" class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-sky-300 hover:file:bg-gray-600 border border-gray-600 rounded-lg cursor-pointer"></div>
                        
                        <button id="generate-button" data-project-id="" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-lg">
                            <ion-icon name="analytics-outline" class="text-xl"></ion-icon> Run Analysis
                        </button>
                    </div>
                </div>

                <div class="max-w-5xl mx-auto">
                    <h3 class="text-xl font-semibold text-white mb-4">Candidate Pipeline</h3>
                    <div id="candidate-list" class="space-y-2">
                        </div>
                </div>
            </div>

            <div id="global-loader" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50">
                <div class="text-center">
                    <svg class="animate-spin h-12 w-12 text-sky-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="text-xl text-white font-bold">Analyzing Candidate...</p>
                    <p class="text-gray-400 mt-2">Fetching GitHub, Parsing Resume, Running AI Models...</p>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        let projects = [];
        let currentProjectId = null;

        // Elements
        const projectListDiv = document.getElementById('project-list');
        const welcomeMessageDiv = document.getElementById('welcome-message');
        const createProjectFormDiv = document.getElementById('create-project-form');
        const projectDashboardDiv = document.getElementById('project-dashboard');
        const candidateListDiv = document.getElementById('candidate-list');
        const globalLoader = document.getElementById('global-loader');
        
        const projectNameInput = document.getElementById('project-name');
        const projectJdInput = document.getElementById('project-jd');
        const usernameInput = document.getElementById('username-input');
        const resumeFile = document.getElementById('resume-file');
        const linkedinFile = document.getElementById('linkedin-file');
        const generateButton = document.getElementById('generate-button');
        const projectSearch = document.getElementById('project-search');
        const candidateSearch = document.getElementById('global-candidate-search');

        function navigateToReport(reportPath, projectId, candidateId) {
            window.location.href = `/report_view?path=${encodeURIComponent(reportPath)}&project_id=${projectId}&candidate_id=${candidateId}`;
        }

        const fetchProjects = async () => {
             try {
                const response = await fetch('/projects/');
                if (!response.ok) throw new Error('Failed fetch');
                projects = await response.json();
                renderProjectList();
                return projects; // Return for chaining
             } catch (error) { console.error(error); }
        };

        const fetchCandidates = async (projectId) => {
            try {
                const response = await fetch(`/projects/${projectId}/candidates/`);
                if (!response.ok) throw new Error('Failed to fetch candidates');
                const candidates = await response.json();
                renderCandidateList(candidates);
            } catch (error) {
                console.error(error);
                candidateListDiv.innerHTML = '<p class="text-red-400 text-sm">Error loading candidates.</p>';
            }
        };

        const saveNewProject = async () => {
             const name = projectNameInput.value.trim();
             const job_description = projectJdInput.value.trim();
             if (!name || !job_description) return alert("Name & JD required");
             try {
                 await fetch('/projects/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, job_description }), });
                 await fetchProjects(); 
                 showWelcome(); 
                 projectNameInput.value = ''; 
                 projectJdInput.value = '';
             } catch(e) { alert("Error saving project"); }
        };

        const handleAnalyze = async () => {
            const pid = generateButton.dataset.projectId;
            const user = usernameInput.value.trim();
            const res = resumeFile.files[0];
            if (!user || !res) return alert("Username & Resume required");

            globalLoader.classList.remove('hidden');

            const fd = new FormData();
            fd.append('username', user); fd.append('resume_file', res);
            if (linkedinFile.files[0]) fd.append('linkedin_file', linkedinFile.files[0]);

            try {
                const resp = await fetch(`/projects/${pid}/summarize`, { method: 'POST', body: fd });
                if (!resp.ok) { const err = await resp.json(); throw new Error(err.detail); }
                const candidate = await resp.json();
                navigateToReport(candidate.report_file_path, pid, candidate.id);
            } catch (e) { alert("Analysis Failed: " + e.message); 
            globalLoader.classList.add('hidden'); }
        };

        // Rendering
        const renderProjectList = () => {
            const term = projectSearch.value.toLowerCase();
            projectListDiv.innerHTML = '';
            const filtered = projects.filter(p => p.name.toLowerCase().includes(term));
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer hover:bg-gray-700 text-sm mb-1 transition-colors ${p.id === currentProjectId ? 'bg-gray-700 border-l-4 border-sky-500' : ''}`;
                div.textContent = p.name;
                div.onclick = () => selectProject(p);
                projectListDiv.appendChild(div);
            });
        };

        const renderCandidateList = (candidates) => {
            candidateListDiv.innerHTML = '';
            if (candidates.length === 0) { candidateListDiv.innerHTML = '<p class="text-gray-500 italic">No candidates analyzed yet.</p>'; return; }
            const term = candidateSearch.value.toLowerCase();
            const filtered = candidates.filter(c => c.github_username.toLowerCase().includes(term) || c.unique_id.includes(term));

            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = 'glass-card p-4 rounded-lg flex justify-between items-center hover:bg-gray-800 transition-colors cursor-pointer group';
                div.onclick = () => navigateToReport(c.report_file_path, c.project_id, c.id);
                const left = document.createElement('div');
                left.innerHTML = `<p class="font-semibold text-white group-hover:text-sky-400 transition-colors">${c.github_username}</p><p class="text-xs text-gray-500">ID: #${c.unique_id}</p>`;
                const right = document.createElement('div');
                const score = c.final_score || 0;
                let color = score >= 75 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400';
                right.innerHTML = `<span class="text-xl font-bold ${color}">${score}%</span>`;
                div.appendChild(left); div.appendChild(right);
                candidateListDiv.appendChild(div);
            });
        };

        // Views
        const showWelcome = () => 
        { 
            welcomeMessageDiv.classList.remove('hidden'); 
            createProjectFormDiv.classList.add('hidden'); 
            projectDashboardDiv.classList.add('hidden'); 
            currentProjectId = null; renderProjectList(); 
        };
        
        const selectProject = (project) => {
            currentProjectId = project.id;
            welcomeMessageDiv.classList.add('hidden'); 
            createProjectFormDiv.classList.add('hidden'); 
            projectDashboardDiv.classList.remove('hidden');
            document.getElementById('project-title-display').textContent = project.name;
            generateButton.dataset.projectId = project.id;
            usernameInput.value = ''; resumeFile.value = ''; 
            linkedinFile.value = '';
            renderProjectList();
            fetchCandidates(project.id);
        };

        document.getElementById('new-project-btn').onclick = () => 
        { 
            welcomeMessageDiv.classList.add('hidden'); 
            projectDashboardDiv.classList.add('hidden'); 
            createProjectFormDiv.classList.remove('hidden'); 
            currentProjectId = null; renderProjectList(); 
        };
        document.getElementById('cancel-project-btn').onclick = showWelcome;
        document.getElementById('save-project-btn').onclick = saveNewProject;
        generateButton.onclick = handleAnalyze;
        projectSearch.oninput = renderProjectList;
        candidateSearch.oninput = () => { 
            if(currentProjectId) fetchCandidates(currentProjectId); 
        };

        // Initialization Logic to Handle "Back" Navigation
        document.addEventListener('DOMContentLoaded', async () => {
            const allProjects = await fetchProjects();
            
            // Check URL params for project_id
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('project_id');
            
            if (pid && allProjects) {
                const proj = allProjects.find(p => p.id == pid);
                if (proj) {
                    selectProject(proj);
                }
            }
        });
    </script>
</body>
</html>